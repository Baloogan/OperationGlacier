@using Newtonsoft.Json
@model OperationGlacier.Models.MapModel
<script>


    var comments_popupOptions = { maxWidth: 600, maxHeight: 400, };

    var comments_json = JSON.parse(@Html.Raw(HttpUtility.JavaScriptStringEncode(JsonConvert.SerializeObject(Model.comments), addDoubleQuotes: true)));
    var map_bounds = map.getBounds();
    $.each(comments_json, function (i, comment_group) {
        var comment_html = "";
        var comment_x;
        var comment_y;
        $.each(comment_group, function (i, comment) {
            comment_x = comment.x;
            comment_y = comment.y;
            comment_html += comment_template(comment);
        });
        var circ_lat = xy_to_lat(comment_x, comment_y);
        var circ_lon = xy_to_lon(comment_x, comment_y);
        var circ = L.circle([circ_lat, circ_lon], 0.4, { color: 'red' })
            .addTo(map)
            .bindPopup(comment_html, comments_popupOptions);
        //only open things on screen
        if (map_bounds.contains([circ_lat, circ_lon])) {
            circ.openPopup();
        }

    });

</script>